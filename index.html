<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>专 砖 - .住</title>
    
    <!-- Meta and PWA tags -->
    <meta name="theme-color" content="#ffffff"/>
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="https://i.postimg.cc/2SbDgD1B/1.png">
    <link rel="icon" href="https://i.postimg.cc/2SbDgD1B/1.png">

    <!-- Fonts and Libraries -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-functions-compat.js"></script>
    
    <style>
        :root {
            --brand: #0b72b9; --accent: #ff9f1c; --bg: #f0f2f5; --card: #ffffff;
            --text-dark: #1a202c; --text-light: #4a5568; --text-muted: #718096;
            --border: #e2e8f0; --success: #38a169; --warning: #dd6b20; --danger: #e53e3e;
            --radius: 16px; --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.07), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --page-transition-duration: 0.4s;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes popIn { 0% { transform: scale(0.9); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        @keyframes slideInUp { from { opacity: 0; transform: translateY(100%); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse-light { 0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 159, 28, 0); } 50% { transform: scale(1.05); box-shadow: 0 0 8px 3px rgba(255, 159, 28, 0.5); } }
        
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        html, body { height: 100%; overflow: hidden; background-color: var(--bg); }
        body { font-family: 'Assistant', sans-serif; color: var(--text-dark); display: flex; flex-direction: column; overscroll-behavior-y: contain; }

        .page { position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow-y: auto; padding: 20px 15px 120px 15px; background-color: var(--bg); visibility: hidden; opacity: 0; transition: transform var(--page-transition-duration) ease, opacity var(--page-transition-duration) ease; transform: translateX(30px); }
        .page.active { visibility: visible; opacity: 1; transform: translateX(0); z-index: 5;}

        .modal-overlay { position: fixed; inset: 0; background-color: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 2000; opacity: 0; visibility: hidden; transition: opacity 0.3s; backdrop-filter: blur(5px); }
        .modal-overlay.show { opacity: 1; visibility: visible; }
        .modal-content { background-color: var(--card); padding: 25px; border-radius: var(--radius); width: 90%; max-width: 500px; animation: popIn 0.3s; }
        
        .full-screen-modal { position: fixed; inset: 0; background-color: var(--bg); z-index: 3000; transform: translateY(100%); transition: transform 0.5s cubic-bezier(0.16, 1, 0.3, 1); display: flex; flex-direction: column; }
        .full-screen-modal.show { transform: translateY(0); }

        #toast-container { position: fixed; bottom: 100px; left: 15px; right: 15px; z-index: 4000; display: flex; flex-direction: column; gap: 10px; align-items: center;}
        .toast { display: flex; align-items: center; gap: 12px; width: 100%; max-width: 400px; background: rgba(30, 41, 59, 0.9); backdrop-filter: blur(10px); color: white; padding: 14px 22px; border-radius: var(--radius); font-weight: 600; box-shadow: var(--shadow); opacity: 0; transform: translateY(20px); transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .toast.show { opacity: 1; transform: translateY(0); }

        .step-indicator { display: flex; gap: 8px; justify-content: center; margin-bottom: 20px; }
        .step-dot { width: 10px; height: 10px; border-radius: 50%; background-color: var(--border); transition: all 0.3s; }
        .step-dot.active { background-color: var(--brand); transform: scale(1.2); }
        .form-step { display: none; }
        .form-step.active { display: block; animation: fadeIn 0.5s; }
    </style>
</head>
<body class="bg-gray-100">

    <div id="splash-screen" class="fixed inset-0 z-50 bg-white flex flex-col justify-center items-center">
        <img src="https://i.postimg.cc/2SbDgD1B/1.png" alt=" .住" class="w-24 h-24 rounded-full shadow-lg">
    </div>

    <div id="app-shell" class="hidden h-full w-full flex-col">
        <header class="flex-shrink-0 bg-white shadow-sm p-3 flex justify-between items-center z-10">
             <div class="profile-container">
                 <img id="profile-avatar" src="" alt="Profile" class="w-10 h-10 rounded-full border-2 border-gray-200">
             </div>
             <button id="project-selector-btn" class="text-lg font-bold text-brand py-1 px-3 rounded-lg hover:bg-gray-100 transition">注 驻专拽...</button>
             <div id="department-filters" class="flex gap-2">
                 <button data-filter="containers" class="filter-btn active text-sm font-semibold py-2 px-4 rounded-full bg-blue-100 text-blue-700">转</button>
                 <button data-filter="haulage" class="filter-btn text-sm font-semibold py-2 px-4 rounded-full bg-gray-100 text-gray-600"></button>
             </div>
        </header>

        <main id="app-container" class="flex-grow relative overflow-hidden">
             <div id="page-dashboard" class="page active">
                 <h1 id="greeting" class="text-3xl font-bold mb-6"></h1>
                 <div id="dashboard-content" class="space-y-4"></div>
             </div>
        </main>
    </div>

    <!-- Modals and Overlays -->
    <div id="login-modal-overlay" class="modal-overlay"></div>
    
    <div id="project-selection-modal" class="modal-overlay">
        <div class="modal-content text-center">
            <h2 class="text-2xl font-bold mb-6">专 驻专拽  拽砖</h2>
            <div id="project-list" class="space-y-4 max-h-60 overflow-y-auto mb-6"></div>
            <div class="grid grid-cols-2 gap-4">
                <button data-action="open-container-order" class="flex flex-col items-center justify-center p-4 bg-blue-50 rounded-lg text-blue-700 h-28 transition-transform transform hover:scale-105">
                    <span class="text-4xl"></span>
                    <span class="font-bold mt-2">转 </span>
                </button>
                <button data-action="open-materials-order" class="flex flex-col items-center justify-center p-4 bg-amber-50 rounded-lg text-amber-700 h-28 transition-transform transform hover:scale-105">
                    <span class="text-4xl">П</span>
                    <span class="font-bold mt-2">专 </span>
                </button>
            </div>
        </div>
    </div>

    <div id="materials-order-form-modal" class="full-screen-modal">
        <div class="flex-shrink-0 bg-white p-4 flex items-center justify-between shadow-sm">
            <h2 class="text-xl font-bold">转 专 </h2>
            <button data-action="close-materials-modal" class="text-2xl font-bold">&times;</button>
        </div>
        <div class="step-indicator p-4"></div>
        <div id="form-content" class="flex-grow p-4 overflow-y-auto">
            
            <div id="step-1" class="form-step">
                <h3 class="font-bold text-lg mb-4">驻专 拽 驻专拽</h3>
                <div class="space-y-4">
                    <div><label class="font-semibold">砖 拽:</label><p id="form-client-name"></p></div>
                    <div><label class="font-semibold">砖 拽砖专:</label><input type="text" id="form-contact-person" class="mt-1 w-full p-2 border rounded-md"></div>
                    <div><label class="font-semibold">驻:</label><input type="tel" id="form-contact-phone" class="mt-1 w-full p-2 border rounded-md"></div>
                </div>
            </div>

            <div id="step-2" class="form-step">
                <h3 class="font-bold text-lg mb-4">驻专 住驻拽</h3>
                 <div class="space-y-4">
                    <div><label class="font-semibold">转转:</label><p id="form-project-address"></p></div>
                    <div><label class="font-semibold" for="form-delivery-date">转专 住驻拽</label><input type="date" id="form-delivery-date" class="mt-1 w-full p-2 border rounded-md"></div>
                    <div>
                        <label class="font-semibold"> </label>
                        <select id="form-delivery-window" class="mt-1 w-full p-2 border rounded-md bg-white">
                            <option value="06:30-10:00">拽专 (06:30 - 10:00)</option>
                            <option value="10:00-13:00">爪专 (10:00 - 13:00)</option>
                            <option value="13:00-16:00">专 爪专 (13:00 - 16:00)</option>
                        </select>
                    </div>
                     <div>
                        <label class="font-semibold">住 </label>
                        <select id="form-haulage-type" class="mt-1 w-full p-2 border rounded-md bg-white">
                            <option value="驻专拽 转">驻专拽 转</option>
                            <option value="转 祝 10 专">转 祝 10 专</option>
                            <option value="转 祝 15 专">转 祝 15 专</option>
                            <option value="注转 祝">注转 祝</option>
                        </select>
                    </div>
                 </div>
            </div>

            <div id="step-3" class="form-step">
                 <h3 class="font-bold text-lg mb-4">专转 爪专</h3>
                 <div class="relative mb-4">
                     <input type="text" id="product-search" placeholder="驻砖 拽, 砖 爪专..." class="w-full p-3 border rounded-md shadow-sm">
                     <div id="product-suggestions" class="absolute z-10 w-full bg-white border rounded-md mt-1 shadow-lg hidden max-h-60 overflow-y-auto"></div>
                 </div>
                 <div class="mb-4">
                    <textarea id="paste-list-input" rows="4" class="w-full p-2 border rounded-md" placeholder="... 拽  专砖 爪注转 专"></textarea>
                 </div>
                 <div id="order-items-list" class="space-y-3"></div>
            </div>

            <div id="step-4" class="form-step">
                <h3 class="font-bold text-lg mb-4">住 砖专 </h3>
                <div id="review-content" class="p-4 border rounded-lg bg-white shadow-inner space-y-4"></div>
            </div>

        </div>
        <div class="flex-shrink-0 p-4 bg-white border-t flex justify-between items-center">
            <button id="prev-step-btn" class="py-2 px-5 bg-gray-200 rounded-md font-semibold">拽</button>
            <button id="next-step-btn" class="py-2 px-5 bg-blue-600 text-white rounded-md font-semibold"></button>
            <button id="submit-order-btn" class="hidden py-2 px-5 bg-green-600 text-white rounded-md font-semibold">砖 </button>
        </div>
        <div id="submission-progress" class="hidden absolute bottom-0 left-0 right-0 h-2 bg-blue-200">
            <div class="h-full bg-blue-500 transition-all duration-500" style="width: 0%"></div>
        </div>
    </div>
    
    <div id="product-details-modal" class="modal-overlay"></div>

    <div id="toast-container"></div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // =====================================================================
            // ===> STEP 1: PASTE YOUR FIREBASE CONFIG OBJECT HERE <===
            // =====================================================================
            const firebaseConfig = {
                // Example:
                // apiKey: "AIza....",
                // authDomain: "hsaban-644c5.firebaseapp.com",
                // projectId: "hsaban-644c5",
                // ...etc
            };
            // =====================================================================

            // Initialize Firebase
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
            const db = firebase.firestore();
            const functions = firebase.functions();
            const auth = firebase.auth();

            let appState = {
                clientId: null,
                clientName: null,
                clientPhone: null,
                avatar: null,
                projects: [],
                activeProject: null,
                orders: [],
                productCatalog: [],
                currentMaterialOrder: {
                    items: [],
                    contactPerson: '',
                    contactPhone: '',
                    deliveryDate: '',
                    deliveryWindow: '06:30-10:00',
                    haulageType: '驻专拽 转',
                    notes: ''
                }
            };

            const dom = {
                // Cache all DOM elements here for performance
            };

            function initApp() {
                // Your existing init logic to check for a client ID in localStorage
                // If found, call loadInitialData(clientId)
                // Else, show the login modal to the user
                console.log("App initialized. Waiting for login.");
                // For now, let's simulate a login for testing:
                 loadInitialData('601963'); // Using Eran's ID for demo
            }

            async function loadInitialData(clientId) {
                console.log(`Loading data for client: ${clientId}`);
                // Here you would typically fetch client data (projects, orders) from your backend
                // This is a placeholder for your existing data fetching logic.
                // For demonstration, we will use mock data.
                appState.clientId = clientId;
                appState.clientName = "注专 ";
                appState.projects = [
                    { id: 'p1', name: '注 爪专驻转', address: '注 爪专驻转 64, 专转 ' },
                    { id: 'p2', name: '驻专拽 转 ', address: '专砖 1, 转 ' }
                ];
                appState.activeProject = appState.projects[0];
                
                // Fetch the product catalog using our new Firebase Function
                try {
                    const getProductCatalog = functions.httpsCallable('getProductCatalog');
                    const result = await getProductCatalog();
                    if (result.data.success) {
                        appState.productCatalog = result.data.catalog;
                        console.log('Product catalog loaded successfully:', appState.productCatalog.length, 'items');
                    } else {
                        showToast('砖 注转 拽 爪专', 'error');
                        console.error('Failed to load catalog:', result.data.error);
                    }
                } catch (error) {
                    console.error("Error fetching product catalog from Firebase Functions:", error);
                    showToast('砖 专 注转 拽', 'error');
                }

                // Render the initial state of the app
                renderApp();
            }
            
            function renderApp() {
                // This function would update the entire UI based on the current appState
                // For example, update the greeting, project selector, etc.
                const greeting = document.getElementById('greeting');
                if (greeting) greeting.textContent = `拽专 , ${appState.clientName.split(' ')[0]}`;
                
                const projectBtn = document.getElementById('project-selector-btn');
                if (projectBtn && appState.activeProject) {
                    projectBtn.textContent = appState.activeProject.name;
                }
                
                // Hide splash screen and show the app
                const splash = document.getElementById('splash-screen');
                const appShell = document.getElementById('app-shell');
                if(splash) splash.style.display = 'none';
                if(appShell) appShell.classList.remove('hidden');

                console.log("App rendered with initial data.");
            }
            
            function showToast(message, type = 'info') {
                const toastContainer = document.getElementById('toast-container');
                if (!toastContainer) return;
                
                const toast = document.createElement('div');
                toast.className = `toast ${type === 'error' ? 'bg-red-600' : 'bg-slate-800'}`;
                toast.textContent = message;
                
                toastContainer.appendChild(toast);
                
                setTimeout(() => toast.classList.add('show'), 10);
                
                setTimeout(() => {
                    toast.classList.remove('show');
                    toast.addEventListener('transitionend', () => toast.remove());
                }, 4000);
            }

            // --- All other functions from your plan go here ---
            // setupEventListeners, form navigation logic, product search,
            // render steps, submit order logic, etc.
            
            // Start the application
            initApp();
            
        });
    </script>
</body>
</html>

