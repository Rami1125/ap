<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM - ניהול הזמנות ח.סבן</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #1e3a8a; --secondary: #1d4ed8; --accent: #f59e0b;
            --bg-light: #f1f5f9; --bg-dark: #0f172a; --card: #ffffff;
            --text-light: #f8fafc; --text-dark: #1e293b; --text-muted: #64748b;
            --border: #e2e8f0; --success: #16a34a; --warning: #f97316; --danger: #dc2626;
            --radius: 12px; --shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.1);
        }
        /* ... existing styles ... */
        body { font-family: 'Assistant', sans-serif; background-color: var(--bg-light); color: var(--text-dark); margin: 0; }
        .container { max-width: 1600px; margin: 0 auto; padding: 20px; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        #logo { font-size: 24px; font-weight: 700; color: var(--primary); }
        .user-info { font-weight: 600; }
        .main-board { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .column { background-color: #eef2ff; border-radius: var(--radius); padding: 15px; }
        .column-title { font-size: 18px; font-weight: 700; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid var(--border); }
        .card { background-color: var(--card); border-radius: 8px; box-shadow: var(--shadow); padding: 15px; margin-bottom: 10px; cursor: grab; border-right: 5px solid var(--primary); }
        .card:active { cursor: grabbing; }
        .card.dragging { opacity: 0.5; }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .card-title { font-weight: 700; }
        .card-timestamp { font-size: 12px; color: var(--text-muted); }
        .card-details ul { padding-right: 20px; margin: 0; font-size: 14px; }
        .card-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 15px; font-size: 12px; }
        .handled-by { color: var(--text-muted); font-style: italic; }
        .whatsapp-btn { background: none; border: none; cursor: pointer; padding: 5px; color: #25D366; }
        .whatsapp-btn:hover { opacity: 0.8; }
        /* --- Styles for the new WhatsApp Modal --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background-color: white; padding: 25px; border-radius: var(--radius); width: 90%; max-width: 500px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -4px rgba(0,0,0,0.1); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-title { font-size: 20px; font-weight: 700; }
        .modal-close { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-muted); }
        .templates-list { list-style: none; padding: 0; margin: 0; max-height: 40vh; overflow-y: auto; }
        .templates-list li { padding: 12px 15px; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 10px; cursor: pointer; transition: background-color 0.2s, border-color 0.2s; }
        .templates-list li:hover { background-color: #f8fafc; border-color: var(--secondary); }
        .template-title { font-weight: 600; display: block; margin-bottom: 5px; }
        .template-content { font-size: 14px; color: var(--text-muted); white-space: pre-wrap; }

    </style>
</head>
<body>
    <div class="container">
        <header>
            <div id="logo">מערכת ניהול | ח.סבן</div>
            <div class="user-info">שלום, <span id="manager-name"></span></div>
        </header>
        <main class="main-board">
            <div class="column" id="new-requests" data-status="חדש">
                <h2 class="column-title">בקשות חדשות</h2>
            </div>
            <div class="column" id="in-progress" data-status="בטיפול">
                <h2 class="column-title">בטיפול</h2>
            </div>
            <div class="column" id="completed" data-status="בוצע">
                <h2 class="column-title">בוצע</h2>
            </div>
        </main>
    </div>

    <!-- --- New WhatsApp Templates Modal --- -->
    <div id="whatsapp-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title" class="modal-title">שליחת עדכון WhatsApp</h3>
                <button id="modal-close-btn" class="modal-close">&times;</button>
            </div>
            <ul id="templates-list" class="templates-list">
                <!-- Templates will be injected here by JavaScript -->
            </ul>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, updateDoc, arrayUnion, serverTimestamp, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // IMPORTANT: Replace with your actual Firebase config
        const firebaseConfig = JSON.parse(atob("YOUR_BASE64_ENCODED_FIREBASE_CONFIG"));

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let managerUser = null;

        // --- WhatsApp Templates Data ---
        // In a future version, this should be fetched from a Cloud Function that reads the Google Sheet.
        const whatsappTemplates = [
            { name: "אישור קבלת הזמנה", content: "שלום [שם לקוח], קיבלנו את בקשתך להזמנה [תעודה] והיא הועברה להכנה. נעדכן בהמשך." },
            { name: "הזמנה בטיפול", content: "שלום [שם לקוח], עדכון לגבי הזמנה [תעודה]: ההזמנה שלך בטיפול הצוות שלנו." },
            { name: "הזמנה יצאה לדרך", content: "שלום [שם לקוח], בשורה טובה! הזמנתך [תעודה] יצאה לדרך. הנהג יצור קשר בסמוך להגעה." },
            { name: "בקשת מיקום", content: "שלום [שם לקוח], לצורך טיפול יעיל בהזמנה [תעודה], נשמח אם תשתף/י איתנו מיקום מדויק. תודה!" },
            { name: "תזכורת (לפני חריגה)", content: "שלום [שם לקוח], תזכורת ידידותית לגבי הזמנה [תעודה]. תאריך הסיום מתקרב. לעדכונים, השב/י להודעה זו." }
        ];

        onAuthStateChanged(auth, (user) => {
            if (user) {
                managerUser = user;
                document.getElementById('manager-name').textContent = user.email || 'מנהל';
                init();
            } else {
                signInAnonymously(auth).catch(error => console.error("Anonymous sign-in failed:", error));
            }
        });

        function init() {
            const requestsCollection = collection(db, "clientRequests");
            
            onSnapshot(requestsCollection, (snapshot) => {
                // Clear all columns before re-rendering
                document.querySelectorAll('.column').forEach(col => {
                    const title = col.querySelector('.column-title').outerHTML;
                    col.innerHTML = title;
                });

                snapshot.docs.forEach(doc => {
                    const request = { id: doc.id, ...doc.data() };
                    const card = createRequestCard(request);
                    const columnId = getColumnIdFromStatus(request.status);
                    document.getElementById(columnId)?.appendChild(card);
                });

                setupDragAndDrop();
            });
        }
        
        function getColumnIdFromStatus(status) {
            switch(status) {
                case 'חדש': return 'new-requests';
                case 'בטיפול': return 'in-progress';
                case 'בוצע': return 'completed';
                default: return 'new-requests';
            }
        }

        function createRequestCard(request) {
            const card = document.createElement('div');
            card.className = 'card';
            card.id = request.id;
            card.draggable = true;

            const detailsHtml = request.requestType === 'הזמנת חומרי בניין'
                ? `<strong>חומרי בניין:</strong><ul>${request.items.map(item => `<li>${item.name} (כמות: ${item.quantity})</li>`).join('')}</ul>`
                : `<p>${request.details || `בקשת ${request.requestType}`}</p>`;

            // Pass the entire request object to the modal opener function
            card.innerHTML = `
                <div class="card-header">
                    <strong class="card-title">${request.clientName}</strong>
                    <span class="card-timestamp">${new Date(request.timestamp?.toDate()).toLocaleString('he-IL')}</span>
                </div>
                <div class="card-details">${detailsHtml}</div>
                <div class="card-footer">
                     <div class="handled-by">${request.handledBy ? `טופל ע"י: ${request.handledBy}`: ''}</div>
                     <button class="whatsapp-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M13.601 2.326A7.854 7.854 0 0 0 7.994 0C3.627 0 .068 3.558.064 7.926c0 1.399.366 2.76 1.057 3.965L0 16l4.204-1.102a7.933 7.933 0 0 0 3.79.965h.004c4.368 0 7.926-3.558 7.93-7.93A7.898 7.898 0 0 0 13.6 2.326zM7.994 14.521a6.573 6.573 0 0 1-3.356-.92l-.24-.144-2.494.654.666-2.433-.156-.251a6.56 6.56 0 0 1-1.007-3.505c0-3.626 2.957-6.584 6.591-6.584a6.56 6.56 0 0 1 4.66 1.931 6.557 6.557 0 0 1 1.928 4.66c-.004 3.639-2.961 6.592-6.592 6.592zm3.615-4.934c-.197-.099-1.17-.578-1.353-.646-.182-.065-.315-.099-.445.099-.133.197-.513.646-.627.775-.114.133-.232.148-.43.05-.197-.1-.836-.308-1.592-.985-.59-.525-.985-1.175-1.103-1.372-.114-.198-.011-.304.088-.403.087-.088.197-.232.296-.346.1-.114.133-.198.198-.33.065-.134.034-.248-.015-.347-.05-.099-.445-1.076-.612-1.47-.16-.389-.323-.335-.445-.34-.114-.007-.247-.007-.38-.007a.729.729 0 0 0-.529.247c-.182.198-.691.677-.691 1.654 0 .977.71 1.916.81 2.049.098.133 1.394 2.132 3.383 2.992.47.205.84.326 1.129.418.475.152.904.129 1.246.08.38-.058 1.171-.48 1.338-.943.164-.464.164-.86.114-.943-.049-.084-.182-.133-.38-.232z"/>
                        </svg>
                     </button>
                </div>
            `;
            // Add event listener directly to the button
            card.querySelector('.whatsapp-btn').addEventListener('click', () => openWhatsAppTemplatesModal(request));
            return card;
        }

        // --- New WhatsApp Modal Logic ---
        const modal = document.getElementById('whatsapp-modal');
        const modalCloseBtn = document.getElementById('modal-close-btn');
        const templatesList = document.getElementById('templates-list');

        async function openWhatsAppTemplatesModal(request) {
            // Step 1: Get Phone Number
            // First, check if number exists on the request.
            // If not, try to fetch from 'clients' collection as a fallback.
            let clientPhoneNumber = request.clientPhoneNumber;
            
            if (!clientPhoneNumber && request.clientId) {
                try {
                    const clientDocRef = doc(db, "clients", String(request.clientId));
                    const clientDoc = await getDoc(clientDocRef);
                    if (clientDoc.exists() && clientDoc.data().phone) {
                         clientPhoneNumber = clientDoc.data().phone;
                    }
                } catch (e) {
                    console.error("Could not fetch client phone number from 'clients' collection:", e);
                }
            }

            if (!clientPhoneNumber) {
                alert("לא נמצא מספר טלפון לשליחת הודעה.");
                return;
            }

            // Step 2: Normalize Phone
            let formattedPhone = clientPhoneNumber.replace(/[^0-9]/g, '');
            if (formattedPhone.startsWith('0')) {
                formattedPhone = '972' + formattedPhone.substring(1);
            } else if (!formattedPhone.startsWith('972')) {
                // Assuming it might already be in international format if not starting with 0
            }
            
            // Step 3: Populate and Show Modal
            templatesList.innerHTML = ''; // Clear previous templates
            whatsappTemplates.forEach(template => {
                let populatedContent = template.content
                    .replace(/\[שם לקוח\]/g, request.clientName || '')
                    .replace(/\[תעודה\]/g, request.id || '');

                const li = document.createElement('li');
                li.innerHTML = `
                    <span class="template-title">${template.name}</span>
                    <p class="template-content">${populatedContent}</p>
                `;
                li.onclick = () => {
                    const encodedMessage = encodeURIComponent(populatedContent);
                    const whatsappUrl = `https://wa.me/${formattedPhone}?text=${encodedMessage}`;
                    window.open(whatsappUrl, '_blank');
                    closeModal();
                };
                templatesList.appendChild(li);
            });
            
            document.getElementById('modal-title').textContent = `שליחת עדכון ל${request.clientName}`;
            modal.style.display = 'flex';
        }

        function closeModal() {
            modal.style.display = 'none';
        }

        modalCloseBtn.onclick = closeModal;
        modal.onclick = (e) => {
            if (e.target === modal) {
                closeModal();
            }
        };


        async function updateRequest(id, newStatus) {
            const requestRef = doc(db, "clientRequests", id);
            try {
                await updateDoc(requestRef, {
                    status: newStatus,
                    handledBy: managerUser.email,
                    updates: arrayUnion({
                        status: newStatus,
                        timestamp: serverTimestamp(),
                        updatedBy: managerUser.email
                    })
                });
            } catch(e) { 
                console.error("Error updating document: ", e);
            }
        }
        
        // --- Drag and Drop Logic ---
        function setupDragAndDrop() {
            const cards = document.querySelectorAll('.card');
            const columns = document.querySelectorAll('.column');
            
            cards.forEach(card => {
                card.addEventListener('dragstart', () => {
                    card.classList.add('dragging');
                });

                card.addEventListener('dragend', () => {
                    card.classList.remove('dragging');
                });
            });

            columns.forEach(column => {
                column.addEventListener('dragover', e => {
                    e.preventDefault();
                    const afterElement = getDragAfterElement(column, e.clientY);
                    const dragging = document.querySelector('.dragging');
                    if (afterElement == null) {
                        column.appendChild(dragging);
                    } else {
                        column.insertBefore(dragging, afterElement);
                    }
                });
                
                column.addEventListener('drop', (e) => {
                    e.preventDefault();
                    const cardId = document.querySelector('.dragging').id;
                    const newStatus = column.dataset.status;
                    updateRequest(cardId, newStatus);
                });
            });
        }
        
        function getDragAfterElement(column, y) {
            const draggableElements = [...column.querySelectorAll('.card:not(.dragging)')];

            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

    </script>
</body>
</html>

